<!-- build time:Mon May 04 2020 16:33:39 GMT+0800 (China Standard Time) --><!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-240x240-playpi.png?v=5.1.3"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-playpi.png?v=5.1.3"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-playpi.png?v=5.1.3"><link rel="mask-icon" href="/images/logo-playpi.svg?v=5.1.3" color="#222"><meta name="keywords" content="Elasticsearch,elasticsearch-hadoop,Spark,Hadoop"><link rel="alternate" href="/atom.xml" title="虾丸派" type="application/atom+xml"><meta name="description" content="在业务中遇到一个由 elasticsearch-hadoop 版本不匹配引发的异常，然后通过查看源代码的方式分析问题、解决问题。不仅解决了业务上的问题，也对 elasticsearch-hadoop 的使用有了更多的了解，同时对于不同版本的 Elasticsearch 集群信息有了更多的认识，这些认识可以让我以后在遇到技术问题时快速定位、少走弯路。本文涉及的开发环境：Elasticsearch v"><meta name="keywords" content="Elasticsearch,elasticsearch-hadoop,Spark,Hadoop"><meta property="og:type" content="article"><meta property="og:title" content="es-hadoop 版本不匹配导致 discoverNodes 异常"><meta property="og:url" content="https://www.playpi.org/2018052901.html"><meta property="og:site_name" content="虾丸派"><meta property="og:description" content="在业务中遇到一个由 elasticsearch-hadoop 版本不匹配引发的异常，然后通过查看源代码的方式分析问题、解决问题。不仅解决了业务上的问题，也对 elasticsearch-hadoop 的使用有了更多的了解，同时对于不同版本的 Elasticsearch 集群信息有了更多的认识，这些认识可以让我以后在遇到技术问题时快速定位、少走弯路。本文涉及的开发环境：Elasticsearch v"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2018/20200225011632.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2018/20200225011729.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2018/20200225011754.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2018/20200225011812.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2018/20200225011936.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2018/20200225011953.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2018/20200225012005.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2018/20200224011208.png"><meta property="og:updated_time" content="2018-05-28T17:04:14.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="es-hadoop 版本不匹配导致 discoverNodes 异常"><meta name="twitter:description" content="在业务中遇到一个由 elasticsearch-hadoop 版本不匹配引发的异常，然后通过查看源代码的方式分析问题、解决问题。不仅解决了业务上的问题，也对 elasticsearch-hadoop 的使用有了更多的了解，同时对于不同版本的 Elasticsearch 集群信息有了更多的认识，这些认识可以让我以后在遇到技术问题时快速定位、少走弯路。本文涉及的开发环境：Elasticsearch v"><meta name="twitter:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2018/20200225011632.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"5.1.3",sidebar:{position:"left",display:"hide",offset:12,b2t:!1,scrollpercent:!0,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://www.playpi.org/2018052901.html"><title>es-hadoop 版本不匹配导致 discoverNodes 异常 | 虾丸派</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">虾丸派</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">烂笔头</h1></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-books"><a href="/books/" rel="section"><i class="menu-item-icon fa fa-fw fa-book"></i><br>书籍</a></li><li class="menu-item menu-item-guide"><a href="/guide/" rel="section"><i class="menu-item-icon fa fa-fw fa-location-arrow"></i><br>指南</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://www.playpi.org/2018052901.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="虾丸派"><meta itemprop="description" content="记录知识 | 分享技术"><meta itemprop="image" content="/images/favicon-1536x1536-playpi.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="虾丸派"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">es-hadoop 版本不匹配导致 discoverNodes 异常</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-29T01:04:14+08:00">2018-05-29 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/series-of-fixbug/" itemprop="url" rel="index"><span itemprop="name">踩坑系列</span> </a></span></span><span id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-divider">|</span> 阅读次数 <span id="busuanzi_value_page_pv"></span></span><div class="post-wordcount"><span class="post-meta-item-text">字数统计</span> <span title="字数统计">2,057字 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">9分钟</span></div></div></header><div class="post-body" itemprop="articleBody"><p>在业务中遇到一个由 <code>elasticsearch-hadoop</code> 版本不匹配引发的异常，然后通过查看源代码的方式分析问题、解决问题。不仅解决了业务上的问题，也对 <code>elasticsearch-hadoop</code> 的使用有了更多的了解，同时对于不同版本的 <code>Elasticsearch</code> 集群信息有了更多的认识，这些认识可以让我以后在遇到技术问题时快速定位、少走弯路。</p><p>本文涉及的开发环境：<code>Elasticsearch v1.7.5</code>、<code>Elasticsearch v2.4.5</code>。</p><a id="more"></a><h1 id="问题出现"><a href="# 问题出现" class="headerlink" title="问题出现"></a>问题出现</h1><p>业务中使用的 <code>elasticsearch-hadoop</code> 版本为 <code>v2.1.0</code>：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt; </span><br><span class="line">  &lt;groupId&gt;org.elasticsearch&lt;/groupId&gt;  </span><br><span class="line">  &lt;artifactId&gt;elasticsearch-hadoop&lt;/artifactId&gt;  </span><br><span class="line">  &lt;version&gt;2.1.0&lt;/version&gt; </span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2018/20200225011632.png" alt="es-hadoop 依赖" title="es-hadoop 依赖"></p><p>一直都是处理 <code>Elasticsearch 1.7.5</code> 的数据，某次临时处理了 <code>Elasticsearch v2.4.5</code> 的数据，结果发现异常，<code>Spark</code> 进程无法启动：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">java.lang.StringIndexOutOfBoundsException: String index out of range: -1</span><br><span class="line">at java.lang.String.substring (String.java:1967)</span><br><span class="line">at org.elasticsearch.hadoop.rest.RestClient.discoverNodes (RestClient.java:110)</span><br><span class="line">at org.elasticsearch.hadoop.rest.InitializationUtils.discoverNodesIfNeeded (InitializationUtils.java:58)</span><br><span class="line">at org.elasticsearch.hadoop.rest.RestService.findPartitions (RestService.java:227)</span><br><span class="line">at org.elasticsearch.spark.rdd.AbstractEsRDD.esPartitions$lzycompute (AbstractEsRDD.scala:51)</span><br><span class="line">at org.elasticsearch.spark.rdd.AbstractEsRDD.esPartitions (AbstractEsRDD.scala:50)</span><br><span class="line">at org.elasticsearch.spark.rdd.AbstractEsRDD.getPartitions (AbstractEsRDD.scala:26)</span><br><span class="line">at org.apache.spark.rdd.RDD$$anonfun$partitions$2.apply (RDD.scala:239)</span><br><span class="line">at org.apache.spark.rdd.RDD$$anonfun$partitions$2.apply (RDD.scala:237)</span><br><span class="line">at scala.Option.getOrElse (Option.scala:120)</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2018/20200225011729.png" alt="异常信息" title="异常信息"></p><p>如果只看 <code>StringIndexOutOfBoundsException</code> 异常，发现就是一个普通的下标越界而已，得不到任何有用的信息，毕竟这是 <code>elasticsearch-hadoop</code> 框架抛出的，给出这样一个异常，并没有指明常见异常类型【例如网络连接问题、数据格式不对等等】，只能顺藤摸瓜去看源代码了。</p><p>再看异常栈里面有一个 <code>RestClient.discoverNodes</code> 定位，基本可以找到源代码所在位置。</p><h1 id="问题分析解决"><a href="# 问题分析解决" class="headerlink" title="问题分析解决"></a>问题分析解决</h1><h2 id="源码查看"><a href="# 源码查看" class="headerlink" title="源码查看"></a> 源码查看</h2><p>直接定位到源代码位置：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings (&#123;&quot;rawtypes&quot;, &quot;unchecked&quot;&#125;)</span><br><span class="line">public List&lt;String&gt; discoverNodes () &#123;</span><br><span class="line">	String endpoint = &quot;_nodes/transport&quot;;</span><br><span class="line">	Map&lt;String, Map&gt; nodes = (Map&lt;String, Map&gt;) get (endpoint, &quot;nodes&quot;);</span><br><span class="line">	List&lt;String&gt; hosts = new ArrayList&lt;String&gt;(nodes.size ());</span><br><span class="line">	for (Map value : nodes.values ()) &#123;</span><br><span class="line">		String inet = (String) value.get (&quot;http_address&quot;);</span><br><span class="line">		if (StringUtils.hasText (inet)) &#123;</span><br><span class="line">			int startIp = inet.indexOf (&quot;/&quot;) + 1;</span><br><span class="line">			int endIp = inet.indexOf (&quot;]&quot;);</span><br><span class="line">			inet = inet.substring (startIp, endIp);</span><br><span class="line">			hosts.add (inet);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return hosts;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2018/20200225011754.png" alt="版本 210 源码" title="版本 210 源码"></p><p>可以看到这是一个发现节点的方法，结合异常栈里面的 <code>RestService.findPartitions</code> 可以猜测这是在读取数据前寻找节点，然后再创建连接。</p><p>异常代码是这一行，如上图红框中的：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inet = inet.substring (startIp, endIp);</span><br></pre></td></tr></table></figure><p>截取网络地址从而获取 <code>ip:port</code> 信息，出现异常，说明网络地址格式不对，以至于按照标准方法截取时出现异常。</p><p>通过代码中的 <code>_nodes/transport</code> 接口【再获取 <code>http_address</code> 的值】，我们可以自己看一下集群的信息：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localhost:9202/_nodes/transport</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2018/20200225011812.png" alt="版本 245 节点信息" title="版本 245 节点信息"></p><p>可以看到 <code>http_address</code> 的值是 <code>ip:port</code> 的格式，而在源代码中是通过截取 <code>/</code>、<code>]</code> 之间的子串来确定 <code>ip:port</code> 的值，这显然会造成 <code>substring</code> 的异常【<code>startIp</code>=0，<code>endIp</code>=-1】。</p><p>其实，对于 <code>ip:port</code> 这种格式的 <code>http_address</code> ，应该直接获取值就行了，不需要截取，但是 <code>v2.1.0</code> 的 <code>elasticsearch-hadoop</code> 还无法考虑到 <code>Elasticsearch v2.4.5</code> 的节点格式，毕竟很难做到向后兼容。</p><p>那我们再回头看一下 <code>v1.7.5</code> 的 <code>Elasticsearch</code> 节点信息：</p><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2018/20200225011936.png" alt="版本 175 节点信息" title="版本 175 节点信息"></p><p>可以看到 <code>http_address</code> 的值是 <code>inet [/ip:port]</code> 的格式，这个刚好可以被源码处理。</p><p>总而言之，<code>v2.1.0</code> 的 <code>elasticsearch-hadoop</code> 无法正确读取处理 <code>Elasticsearch v2.4.5</code> 的节点信息，所以也就无法处理数据了。</p><h2 id="升级版本"><a href="# 升级版本" class="headerlink" title="升级版本"></a>升级版本</h2><p>解决方案也很简单，直接升级 <code>elasticsearch-hadoop</code> 的版本即可，找到适配 <code>Elasticsearch v2.4.5</code> 的，那干脆配置一个一样的版本：<code>v2.4.5</code>。</p><p>不妨也来看一看它的源码是怎样的：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings (&#123; &quot;rawtypes&quot;, &quot;unchecked&quot; &#125;)</span><br><span class="line">public List&lt;String&gt; discoverNodes () &#123;</span><br><span class="line">	String endpoint = &quot;_nodes/transport&quot;;</span><br><span class="line">	Map&lt;String, Map&gt; nodes = (Map&lt;String, Map&gt;) get (endpoint, &quot;nodes&quot;);</span><br><span class="line">	List&lt;String&gt; hosts = new ArrayList&lt;String&gt;(nodes.size ());</span><br><span class="line">	for (Map value : nodes.values ()) &#123;</span><br><span class="line">		String inet = (String) value.get (&quot;http_address&quot;);</span><br><span class="line">		if (StringUtils.hasText (inet)) &#123;</span><br><span class="line">			hosts.add (StringUtils.parseIpAddress (inet).toString ());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return hosts;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2018/20200225011953.png" alt="版本 245 源码 1" title="版本 245 源码 1"></p><p>可以看到，源码单独重新写了一个方法处理 <code>ip:port</code> 的信息，想必是考虑了多种情况，接着往下看：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public static IpAndPort parseIpAddress (String httpAddr) &#123;</span><br><span class="line">	//strip ip address - regex would work but it&apos;s overkill</span><br><span class="line">	//there are four formats - ip:port, hostname/ip:port or [/ip:port] and [hostname/ip:port]</span><br><span class="line">	//first the ip is normalized</span><br><span class="line">	if (httpAddr.contains (&quot;/&quot;)) &#123;</span><br><span class="line">		int startIp = httpAddr.indexOf (&quot;/&quot;) + 1;</span><br><span class="line">		int endIp = httpAddr.indexOf (&quot;]&quot;);</span><br><span class="line">		if (endIp &lt; 0) &#123;</span><br><span class="line">			endIp = httpAddr.length ();</span><br><span class="line">		&#125;</span><br><span class="line">		if (startIp &lt; 0) &#123;</span><br><span class="line">			throw new EsHadoopIllegalStateException (&quot;Cannot parse http address &quot; + httpAddr);</span><br><span class="line">		&#125;</span><br><span class="line">		httpAddr = httpAddr.substring (startIp, endIp);</span><br><span class="line">	&#125;</span><br><span class="line">	//then split</span><br><span class="line">	int portIndex = httpAddr.lastIndexOf (&quot;:&quot;);</span><br><span class="line">	if (portIndex &gt; 0) &#123;</span><br><span class="line">		String ip = httpAddr.substring (0, portIndex);</span><br><span class="line">		int port = Integer.valueOf (httpAddr.substring (portIndex + 1));</span><br><span class="line">		return new IpAndPort (ip, port);</span><br><span class="line">	&#125;</span><br><span class="line">	return new IpAndPort (httpAddr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2018/20200225012005.png" alt="版本 245 源码 2" title="版本 245 源码 2"></p><p>果然，考虑周全，一共四种情况全部考虑到。这样的话，就可以利用 <code>elasticsearch-hadoop v2.4.5</code> 愉快地处理各种版本的 <code>Elasticsearch</code> 集群里面的数据了。</p><h2 id="多版本小技巧"><a href="# 多版本小技巧" class="headerlink" title="多版本小技巧"></a>多版本小技巧</h2><p>在 <code>Maven</code> 项目中，如果的确需要应对多版本的 <code>Elasticsearch</code> 环境，而又不能同时依赖两个版本的 <code>elasticsearch-hadoop</code> 包，那怎么办呢，总不能写两套代码吧，或者至少需要两份 <code>pom.xml</code> 文件。</p><p>其实，大可不必，<code>Maven</code> 中有非常好用的 <code>profile</code> 功能，可以在编译打包时动态指定激活哪一份配置。</p><p>在 <code>pom.xml</code> 中设置全局变量：<code>elastisearch.hadoop.version</code>，默认值为 <code>2.1.0</code>，在指定 <code>elasticsearch-hadoop</code> 依赖版本时直接使用：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> 全局变量 </span><br><span class="line">&lt;properties&gt;</span><br><span class="line">    &lt;elastisearch.hadoop.version&gt;2.1.0&lt;/elastisearch.hadoop.version&gt;</span><br><span class="line">&lt;/properties&gt;</span><br><span class="line"></span><br><span class="line"> 直接使用 </span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.elasticsearch&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;elasticsearch-hadoop&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;elastisearch.hadoop.version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>这样的话打包时使用的是 <code>elasticsearch-hadoop v2.1.0</code>。</p><p>如果接着利用 <code>profile</code> 功能【一般加载线上环境、测试环境的配置文件时也会用到这个特性】，在 <code>pom.xml</code> 中配置：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;profiles&gt;</span><br><span class="line">    &lt;profile&gt;</span><br><span class="line">        &lt;id&gt;es-245&lt;/id&gt;</span><br><span class="line">        &lt;properties&gt;</span><br><span class="line">            &lt;elastisearch.hadoop.version&gt;2.4.5&lt;/elastisearch.hadoop.version&gt;</span><br><span class="line">        &lt;/properties&gt;</span><br><span class="line">    &lt;/profile&gt;</span><br><span class="line">&lt;/profiles&gt;</span><br></pre></td></tr></table></figure><p>它其实就是更改了 <code>elastisearch.hadoop.version</code> 变量的值，但是需要编译打包时激活才会有效，编译打包时使用 <code>-P</code> 参数指定配置对应的 <code>id</code>：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean compile package -P es-245</span><br></pre></td></tr></table></figure><p>表示激活 <code>es-245</code> 这个配置，那么 <code>elastisearch.hadoop.version</code> 变量的值就变为 <code>2.4.5</code> 了，则对应的依赖版本也就是它了，灵活好用。</p><h1 id="等价的依赖"><a href="# 等价的依赖" class="headerlink" title="等价的依赖"></a>等价的依赖</h1><p>另外还有一种 <code>elasticsearch-spark</code> 依赖，它和 <code>elasticsearch-hadoop</code> 一样，添加了对 <code>Elasticsearch</code> 并发处理的支持扩展，并且它们大部分的源码是一样的，只不过对于 <code>Spark SQL</code> 的版本支持不一致。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt; </span><br><span class="line">  &lt;groupId&gt;org.elasticsearch&lt;/groupId&gt;  </span><br><span class="line">  &lt;artifactId&gt;elasticsearch-spark_2.10&lt;/artifactId&gt;  </span><br><span class="line">  &lt;version&gt;2.1.0&lt;/version&gt; </span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2018/20200224011208.png" alt="es-spark 依赖" title="es-spark 依赖"></p><p>看官网说明是为了支持 <code>spark SQL</code> 的，链接：<a href="https://www.elastic.co/guide/en/elasticsearch/hadoop/master/spark.html" target="_blank" rel="noopener">Supported Spark SQL versions</a> 。</p><blockquote><p>Spark SQL while becoming a mature component, is still going through significant changes between releases. Spark SQL became a stable component in version 1.3, however it is not backwards compatible with the previous releases. Further more Spark 2.0 introduced significant changed which broke backwards compatibility, through the Dataset API. elasticsearch-hadoop supports both version Spark SQL 1.3-1.6 and Spark SQL 2.0 through two different jars: elasticsearch-spark-1.x-\<version>.jar and elasticsearch-hadoop-\<version>.jar support Spark SQL 1.3-1.6 (or higher) while elasticsearch-spark-2.0-\<version>.jar supports Spark SQL 2.0. In other words, unless you are using Spark 2.0, use elasticsearch-spark-1.x-\<version>.jar</version></version></version></version></p></blockquote><h1 id="备注"><a href="# 备注" class="headerlink" title="备注"></a>备注</h1><p>最好还是升级 <code>elasticsearch-hadoop</code> 版本与 <code>Elasticsearch</code> 保持一致，例如升级到 <code>v2.4.5</code>【与 <code>Elasticsearch</code> 版本保持一致】。</p><p>但是，<code>v2.4.5</code> 版本的 <code>elasticsearch-hadoop</code> 自有它的坑【是很严重的 <code>bug</code>】，那就是它在处理数据时，会过滤掉中文的字段，导致读取中文字段丢失，影响中间的 <code>ETL</code> 处理逻辑。而如果数据处理完成后，再写回去原来的 <code>Elasticsearch</code> 索引就悲剧了，采用 <code>index</code> 方式会覆盖数据，导致中文字段全部丢失；采用 <code>update</code> 方式不会导致数据覆盖。</p><p>中文字段丢失问题，只针对某些版本，关于此问题的踩坑记录可以参考我的另外一篇博客：<a href="https://www.playpi.org/2017102301.html">es-hadoop 读取中文字段丢失问题</a> 。</p><p><code>Elasticsearch-hadoop v5.x</code> 版本分散了依赖包的功能，单独拆分出来 <code>elasticsearch-rest-client</code> 用于请求相关的功能，类的包名也变为了 <code>org.elasticsearch.rest</code>。</p></div><div><div id="wechat_subscriber" style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center"><img id="wechat_subscriber_qcode" src="/images/wechat-qr-personal.jpg" alt="虾丸派 wechat" style="width:200px;max-width:100%"><div>扫一扫添加博主，进技术交流群，共同学习进步</div></div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>永不止步</div><button id="rewardButton" disable="enable" onclick='var e=document.getElementById("QR");"none"===e.style.display?e.style.display="block":e.style.display="none"'><span>打赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"><img id="wechat_qr" src="/images/wechat-pay-playpi.png" alt="虾丸派 微信支付"><p>微信支付</p></div></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong> 虾丸派</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://www.playpi.org/2018052901.html" title="es-hadoop 版本不匹配导致 discoverNodes 异常">https://www.playpi.org/2018052901.html</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Elasticsearch/" rel="tag"><i class="fa fa-tag"></i> Elasticsearch</a> <a href="/tags/Hadoop/" rel="tag"><i class="fa fa-tag"></i> Hadoop</a> <a href="/tags/Spark/" rel="tag"><i class="fa fa-tag"></i> Spark</a> <a href="/tags/elasticsearch-hadoop/" rel="tag"><i class="fa fa-tag"></i> elasticsearch-hadoop</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2018051401.html" rel="next" title="Elasticsearch 常用 HTTP 接口"><i class="fa fa-chevron-left"></i> Elasticsearch 常用 HTTP 接口</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2018053002.html" rel="prev" title="Elasticsearch 写入数据文本过长：IllegalArgumentException">Elasticsearch 写入数据文本过长：IllegalArgumentException <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="vcomments"></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/favicon-1536x1536-playpi.png" alt="虾丸派"><p class="site-author-name" itemprop="name">虾丸派</p><p class="site-description motion-element" itemprop="description">记录知识 | 分享技术</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">141</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">12</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">291</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/iplaypi" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://weibo.com/u/3086148515" target="_blank" title="微博"><i class="fa fa-fw fa-weibo"></i>微博</a> </span><span class="links-of-author-item"><a href="mailto:playpi@qq.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div><div class="cc-license motion-element" itemprop="license"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank" rel="external nofollow"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://github.com/iplaypi" title="GitHub" target="_blank" rel="external nofollow">GitHub</a></li><li class="links-of-blogroll-item"><a href="https://weibo.com/u/3086148515" title="Weibo" target="_blank" rel="external nofollow">Weibo</a></li><li class="links-of-blogroll-item"><a href="https://www.playpi.org" title="虾丸派" target="_blank" rel="external nofollow">虾丸派</a></li><li class="links-of-blogroll-item"><a href="https://www.playpi.org" title="playpi" target="_blank" rel="external nofollow">playpi</a></li><li class="links-of-blogroll-item"><a href="https://www.liaoxuefeng.com" title="廖雪峰" target="_blank" rel="external nofollow">廖雪峰</a></li><li class="links-of-blogroll-item"><a href="http://www.ruanyifeng.com" title="阮一峰" target="_blank" rel="external nofollow">阮一峰</a></li><li class="links-of-blogroll-item"><a href="https://travis-ci.org/iplaypi/iplaypi.github.io" title="travis-ci" target="_blank" rel="external nofollow">travis-ci</a></li><li class="links-of-blogroll-item"><a href="https://www.vultr.com/?ref=7861302-4F" title="Vultr" target="_blank" rel="external nofollow">Vultr</a></li></ul></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#问题出现"><span class="nav-number">1.</span> <span class="nav-text">问题出现</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#问题分析解决"><span class="nav-number">2.</span> <span class="nav-text">问题分析解决</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#源码查看"><span class="nav-number">2.1.</span> <span class="nav-text">源码查看</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#升级版本"><span class="nav-number">2.2.</span> <span class="nav-text">升级版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多版本小技巧"><span class="nav-number">2.3.</span> <span class="nav-text">多版本小技巧</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#等价的依赖"><span class="nav-number">3.</span> <span class="nav-text">等价的依赖</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#备注"><span class="nav-number">4.</span> <span class="nav-text">备注</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2016&ndash;<span itemprop="copyrightYear">2020</span> <span class="post-meta-divider">|</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">虾丸派</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">全站字数统计</span> <span title="全站字数统计">316.9k 字</span></div><div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io" rel="external nofollow">Hexo</a> 强力驱动</div><span class="post-meta-divider">|</span><div class="theme-info">主题&nbsp;<a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next" rel="external nofollow">NexT.Mist</a><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-divider">|</span> 总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-divider">|</span> 总访客 <span id="busuanzi_value_site_uv"></span> 人</span></div><div class="busuanzi-count"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script><script src="//unpkg.com/valine@1.3.7/dist/Valine.min.js"></script><script type="text/javascript">new Valine({av:AV,el:"#comments",verify:!1,notify:!1,app_id:"FC5Jijeg1meo2K2OzPYWK327-gzGzoHsz",app_key:"6A1ReY8tjhPutK00F01YbJSq",placeholder:"没有问题吗？"})</script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){function r(e,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===t&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url),d=[],g=[];if(""!=l&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}d=d.concat(e(t,h,!1)),g=g.concat(e(t,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;w<0&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(t){b+="<a href='"+f+'\'><p class="search-result">'+s(p,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){var e=27===t.which&&$(".search-popup").is(":visible");e&&onPopupClose()})</script><script>!function(){var t=document.createElement("script"),s=window.location.protocol.split(":")[0];"https"===s?t.src="https://zz.bdstatic.com/linksubmit/push.js":t.src="http://push.zhanzhang.baidu.com/push.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.3"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{scale:1,jsonPath:"/live2dw/assets/hijiki.model.json"},display:{position:"left",width:100,height:200,hOffset:0,vOffset:-20},mobile:{show:!1,motion:!0,scale:.3},log:!1})</script></body></html><!-- rebuild by neat -->