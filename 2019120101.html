<!-- build time:Sun Mar 15 2020 16:52:22 GMT+0800 (China Standard Time) --><!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-240x240-playpi.png?v=5.1.3"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-playpi.png?v=5.1.3"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-playpi.png?v=5.1.3"><link rel="mask-icon" href="/images/logo-playpi.svg?v=5.1.3" color="#222"><meta name="keywords" content="Java,Maven,shade"><link rel="alternate" href="/atom.xml" title="虾丸派" type="application/atom+xml"><meta name="description" content="最近因为协助升级相关业务的 sdk，遇到过多次 jar 包冲突的问题，此外自己在业务中升级算法接口的 sdk 时，也遇到过 jar 冲突问题。而且，这种冲突是灾难性的，不要指望通过排除特定包、升级版本、降级版本解决，根本无济于事，还会越来越混乱。那么，最高效的方法是使用 maven-shade-plugin 插件，只要加上冲突相关的 relocation 配置，变更包名，即可迅速化解冲突的问题。"><meta name="keywords" content="Java,Maven,shade"><meta property="og:type" content="article"><meta property="og:title" content="解决 jar 包冲突的神器：maven-shade-plugin"><meta property="og:url" content="https://www.playpi.org/2019120101.html"><meta property="og:site_name" content="虾丸派"><meta property="og:description" content="最近因为协助升级相关业务的 sdk，遇到过多次 jar 包冲突的问题，此外自己在业务中升级算法接口的 sdk 时，也遇到过 jar 冲突问题。而且，这种冲突是灾难性的，不要指望通过排除特定包、升级版本、降级版本解决，根本无济于事，还会越来越混乱。那么，最高效的方法是使用 maven-shade-plugin 插件，只要加上冲突相关的 relocation 配置，变更包名，即可迅速化解冲突的问题。"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208195230.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208015421.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208015600.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208015629.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208014735.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208013756.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208014710.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208185321.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208185900.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208190909.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208192045.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208192409.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208192525.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208195142.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200209205501.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200209205616.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200209205712.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200209205731.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200209205746.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200209205801.png"><meta property="og:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208200838.png"><meta property="og:updated_time" content="2019-11-30T16:54:21.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="解决 jar 包冲突的神器：maven-shade-plugin"><meta name="twitter:description" content="最近因为协助升级相关业务的 sdk，遇到过多次 jar 包冲突的问题，此外自己在业务中升级算法接口的 sdk 时，也遇到过 jar 冲突问题。而且，这种冲突是灾难性的，不要指望通过排除特定包、升级版本、降级版本解决，根本无济于事，还会越来越混乱。那么，最高效的方法是使用 maven-shade-plugin 插件，只要加上冲突相关的 relocation 配置，变更包名，即可迅速化解冲突的问题。"><meta name="twitter:image" content="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208195230.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"5.1.3",sidebar:{position:"left",display:"hide",offset:12,b2t:!1,scrollpercent:!0,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://www.playpi.org/2019120101.html"><title>解决 jar 包冲突的神器：maven-shade-plugin | 虾丸派</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">虾丸派</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">烂笔头</h1></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-books"><a href="/books/" rel="section"><i class="menu-item-icon fa fa-fw fa-book"></i><br>书籍</a></li><li class="menu-item menu-item-guide"><a href="/guide/" rel="section"><i class="menu-item-icon fa fa-fw fa-location-arrow"></i><br>指南</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://www.playpi.org/2019120101.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="虾丸派"><meta itemprop="description" content="记录知识 | 分享技术"><meta itemprop="image" content="/images/favicon-1536x1536-playpi.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="虾丸派"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">解决 jar 包冲突的神器：maven-shade-plugin</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-01T00:54:21+08:00">2019-12-01 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/series-of-fixbug/" itemprop="url" rel="index"><span itemprop="name">踩坑系列</span> </a></span></span><span id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-divider">|</span> 阅读次数 <span id="busuanzi_value_page_pv"></span></span><div class="post-wordcount"><span class="post-meta-item-text">字数统计</span> <span title="字数统计">5,535字 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">23分钟</span></div></div></header><div class="post-body" itemprop="articleBody"><p>最近因为协助升级相关业务的 <code>sdk</code>，遇到过多次 <code>jar</code> 包冲突的问题，此外自己在业务中升级算法接口的 <code>sdk</code> 时，也遇到过 <code>jar</code> 冲突问题。而且，这种冲突是灾难性的，不要指望通过排除特定包、升级版本、降级版本解决，根本无济于事，还会越来越混乱。</p><p>那么，最高效的方法是使用 <code>maven-shade-plugin</code> 插件，只要加上冲突相关的 <code>relocation</code> 配置，变更包名，即可迅速化解冲突的问题。</p><a id="more"></a><p>在此提前说明，下文中涉及的代码已经被我上传至 <code>GtiHub</code>：<a href="https://github.com/iplaypi/iplaypistudy-shade" target="_blank" rel="noopener">iplaypistudy-shade</a> ，特别独立创建了一个 <code>Maven</code> 小项目，专供演示使用，读者可以提前下载使用。</p><h1 id="前提场景"><a href="# 前提场景" class="headerlink" title="前提场景"></a>前提场景</h1><p>在 <code>Maven</code> 项目中，当功能越来越丰富，需要的第三方依赖也就越来越多，此时很容易发生 <code>jar</code> 包冲突。而通常是因为，<code>Mavne</code> 项目中依赖了同一个 <code>jar</code> 包的多个版本，即坐标版本号不同。</p><p>一般的思路是只保留一个版本，删除掉不需要的版本，但是在复杂情况下，版本之间不兼容，不可能就这么删掉某一个【因为多个 <code>jar</code> 分别被引用了不同的方法】，所以这种思路行不通。</p><p>例如我最近遇到了一个下图这样的例子【本文开头指定的 <code>GitHub</code> 源代码可以直接下载】：</p><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208195230.png" alt="依赖冲突的项目结构" title="依赖冲突的项目结构"></p><p>其中，<code>module-a</code>、<code>module-b</code>、<code>module-c</code> 是我项目中的三个模块，<code>module-a</code> 同时依赖了子模块 <code>module-b</code> 和 <code>module-c</code>，这个很容易理解。</p><p>但是，在 <code>module-b</code>、<code>module-c</code> 中分别依赖了不同版本的 <code>guava</code>，并且在代码中有实际调用不兼容的方法，高版本的方法在低版本中不存在，低版本的方法在高版本中不存在【这属于 <code>guava</code> 没有做到向前兼容的问题】。</p><p>代码具体内容在后面的演示中会详细描述，这里先探讨一下这种情况该怎么办。</p><p>如果排除掉 <code>guava v19.0</code> 的话【使用 <code>exclude</code> 特性】，<code>module-b</code> 会报错，如果排除掉 <code>guava v26.0-jre</code> 的话，<code>module-c</code> 会报错，但是我又希望在项目中可以同时使用 <code>guava v19.0</code> 和 <code>guava v26.0-jre</code>，为了功能考虑也必须同时使用，不能排除任何一个。</p><p>好像陷入了僵局，反正我一开始是没有什么好办法的，直到有一位同事，在我旁边偶尔提了一句，你可以使用 <code>maven-shade-plugin</code> 插件，能完美解决你这个需求场景，方便快捷，毫无痛苦。</p><p>我自己先去了解了一下，后来又听他解释了一遍，才恍然大悟，感觉技术观念再一次被刷新了，居然还有这种操作。</p><p>下面就简单描述一下具体怎么使用 <code>maven-shade-plugin</code> 插件解决这个问题。</p><h1 id="解决方案演示"><a href="# 解决方案演示" class="headerlink" title="解决方案演示"></a>解决方案演示</h1><h2 id="案例说明"><a href="# 案例说明" class="headerlink" title="案例说明"></a> 案例说明</h2><p>由于是演示 <code>maven-shade-plugin</code> 插件的使用，所以仅仅只有几行核心代码、几个核心依赖，但是完全可以表达出解决冲突的思路，源代码请读者从本文开头指定的 <code>GitHub</code> 链接下载。</p><p>如上图所示，<code>module-a</code>、<code>module-b</code>、<code>module-c</code> 是我项目中的三个模块，<code>module-a</code> 同时依赖了子模块 <code>module-b</code> 和 <code>module-c</code>。在子模块 <code>module-b</code> 中，依赖了 <code>guava v19.0</code>，在 子模块 <code>module-c</code> 中，依赖了 <code>guava v26.0-jre</code>。</p><p>好，接下来重点来了，在 <code>guava</code> 的两个版本中有下面两个不兼容的方法，特意挑选出来，用来测试：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 这个方法在 v19.0 中有，在 v26.0-jre 中没有 </span><br><span class="line">@CheckReturnValue</span><br><span class="line">  @Deprecated</span><br><span class="line">  public static ToStringHelper toStringHelper (Object self) &#123;</span><br><span class="line">	return new ToStringHelper (self.getClass ().getSimpleName ());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 这个方法在 v26.0-jre 中有，在 v19.0 中没有 </span><br><span class="line">public static String lenientFormat (@Nullable String template, @Nullable Object... args) &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当然，如果在 <code>module-b</code>、<code>module-c</code> 的依赖 <code>jar</code> 源码中有调用到，也是可以的，但是不直观，而且依赖 <code>jar</code> 的方法也不一定会执行，不好控制，所以我选择手动显式写代码调用的方式来演示。</p><h2 id="代码清单"><a href="# 代码清单" class="headerlink" title="代码清单"></a>代码清单</h2><p>演示代码主要内容如下。</p><p>在 <code>module-b</code> 中有一个类 <code>ModuleBRun</code>，调用了 <code>toStringHelper ()</code> 方法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j</span><br><span class="line">public class ModuleBRun &#123;</span><br><span class="line">	public static void main (String [] args) &#123;</span><br><span class="line">		log.info (&quot;====Hello World!&quot;);</span><br><span class="line">		run ();</span><br><span class="line">	&#125;</span><br><span class="line">	public static void run () &#123;</span><br><span class="line">		// 这个方法在 v19.0 中有，在 v26.0-jre 中没有 </span><br><span class="line">		log.info (&quot;==== 开始执行 module-b 的代码 & quot;);</span><br><span class="line">		Objects.ToStringHelper toStringHelper = Objects.toStringHelper (new Object ());</span><br><span class="line">		toStringHelper.add (&quot;in&quot;, &quot;in&quot;);</span><br><span class="line">		toStringHelper.add (&quot;out&quot;, &quot;out&quot;);</span><br><span class="line">		log.info (&quot;====[&#123;&#125;]&quot;, toStringHelper.toString ());</span><br><span class="line">		log.info (&quot;====module-b 的代码执行完成 & quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208015421.png" alt="ModuleBRun" title="ModuleBRun"></p><p>在 <code>module-c</code> 中有一个类 <code>ModuleCRun</code>，调用了 <code>lenientFormat ()</code> 方法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j</span><br><span class="line">public class ModuleCRun &#123;</span><br><span class="line">	public static void main (String [] args) &#123;</span><br><span class="line">		log.info (&quot;====Hello World!&quot;);</span><br><span class="line">		run ();</span><br><span class="line">	&#125;</span><br><span class="line">	public static void run () &#123;</span><br><span class="line">		log.info (&quot;==== 开始执行 module-c 的代码 & quot;);</span><br><span class="line">		// 这个方法在 v26.0-jre 中有，在 v19.0 中没有 </span><br><span class="line">		log.info (&quot;====[&#123;&#125;]&quot;, Strings.lenientFormat (&quot;&quot;, &quot;in&quot;, &quot;out&quot;));</span><br><span class="line">		log.info (&quot;====module-c 的代码执行完成 & quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208015600.png" alt="ModuleCRun" title="ModuleCRun"></p><p>在 <code>module-a</code> 中有一个类 <code>ModuleARun</code>，有一个 <code>run ()</code> 方法，分别调用了上面的 <code>ModuleBRun.run ()</code>、<code>ModuleCRun.run ()</code>：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">     * 依赖 b/c 时，无法成功运行 </span><br><span class="line">     * &lt;p&gt;</span><br><span class="line">     * 依赖 b/c-shade 时，可以成功运行 </span><br><span class="line">     */</span><br><span class="line">public static void run () &#123;</span><br><span class="line">	log.info (&quot;==== 开始执行 module-a 的代码 & quot;);</span><br><span class="line">	ModuleBRun.run ();</span><br><span class="line">	ModuleCRun.run ();</span><br><span class="line">	log.info (&quot;====module-a 的代码执行完成 & quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208015629.png" alt="ModuleARun" title="ModuleARun"></p><h2 id="运行效果"><a href="# 运行效果" class="headerlink" title="运行效果"></a>运行效果</h2><p>此时，尝试本地调试运行 <code>ModuleARun.run ()</code>，或者使用 <code>Maven</code> 打 <code>jar</code> 包后运行：<code>java -jar iplaypistudy-shade-module-a-1.0-SNAPSHOT-jar-with-dependencies.jar</code>，需要提前使用 <code>maven-shade-plugin</code> 配置 <code>mainClass</code> 后打包。</p><p>可以发现如下错误：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">2020-02-08_01:27:25 [main] INFO study.ModuleARun:13: ====Hello World!</span><br><span class="line">2020-02-08_01:27:25 [main] INFO study.ModuleARun:24: ==== 开始执行 module-a 的代码 </span><br><span class="line">2020-02-08_01:27:25 [main] INFO study.ModuleBRun:19: ==== 开始执行 module-b 的代码 </span><br><span class="line">2020-02-08_01:27:25 [main] INFO study.ModuleBRun:23: ====[Object&#123;in=in, out=out&#125;]</span><br><span class="line">2020-02-08_01:27:25 [main] INFO study.ModuleBRun:24: ====module-b 的代码执行完成 </span><br><span class="line">2020-02-08_01:27:25 [main] INFO study.ModuleCRun:18: ==== 开始执行 module-c 的代码 </span><br><span class="line">Exception in thread &quot;main&quot; java.lang.NoSuchMethodError: com.google.common.base.Strings.lenientFormat (Ljava/lang/String;[Ljava/lang/Object;) Ljava/lang/String;</span><br><span class="line">	at org.playpi.study.ModuleCRun.run (ModuleCRun.java:20)</span><br><span class="line">	at org.playpi.study.ModuleARun.run (ModuleARun.java:26)</span><br><span class="line">	at org.playpi.study.ModuleARun.main (ModuleARun.java:14)</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208014735.png" alt="调试运行结果" title="调试运行结果"></p><p>看到 <code>NoSuchMethodError</code> 就知道出现了严重的问题，如果试图使用搜索功能搜索 <code>Strings</code> 这个类，可以发现有 2 个一模一样的类，但是他们对应的 <code>guava jar</code> 的版本号不一致。这时候有经验的工程师就可以立马判断，编译运行 <code>JVM</code> 加载的 <code>jar</code> 对于 <code>ModuleCRun.run ()</code> 方法来说是有问题的，只加载了特定版本的 <code>guava jar</code>，确保了 <code>ModuleBRun.run ()</code> 方法可以顺利执行【和手动排除 <code>module-c</code> 中的 <code>guava v26.0-jre</code> 一个效果】。</p><p>如果是编译打包后使用 <code>java</code> 命令再运行，可以发现同样的错误，如果此时尝试解压 <code>jar</code> 包，反编译源码，查看具体的类，可以看到编译打包后有些类是不存在的【多版本的 <code>jar</code> 只会保留一个，就会导致另一个 <code>jar</code> 中的类全部丢失，如果此时恰好有不兼容的类，那就出问题】。</p><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208013756.png" alt="搜索 Strings 类" title="搜索 Strings 类"></p><p>那有人会想到，能不能手动排除 <code>module-a</code> 中的 <code>guava v19.0</code> 呢，我来试试，在 <code>module-a</code> 的 <code>pom.xml</code> 中对 <code>module-b</code> 添加 <code>exclude</code> 属性：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.playpi.study&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;iplaypistudy-shade-module-b&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;parent.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;!-- 这里排除会导致调用 ModuleBRun.run () 时出现 NoSuchMethodError --&gt;</span><br><span class="line">    &lt;exclusions&gt;</span><br><span class="line">        &lt;exclusion&gt;</span><br><span class="line">            &lt;groupId&gt;com.google.guava&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;guava&lt;/artifactId&gt;</span><br><span class="line">        &lt;/exclusion&gt;</span><br><span class="line">    &lt;/exclusions&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>调试运行结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">2020-02-08_01:40:33 [main] INFO study.ModuleARun:13: ====Hello World!</span><br><span class="line">2020-02-08_01:40:33 [main] INFO study.ModuleARun:24: ==== 开始执行 module-a 的代码 </span><br><span class="line">2020-02-08_01:40:33 [main] INFO study.ModuleBRun:19: ==== 开始执行 module-b 的代码 </span><br><span class="line">Exception in thread &quot;main&quot; java.lang.NoSuchMethodError: com.google.common.base.Objects.toStringHelper (Ljava/lang/Object;) Lcom/google/common/base/Objects$ToStringHelper;</span><br><span class="line">	at org.playpi.study.ModuleBRun.run (ModuleBRun.java:20)</span><br><span class="line">	at org.playpi.study.ModuleARun.run (ModuleARun.java:25)</span><br><span class="line">	at org.playpi.study.ModuleARun.main (ModuleARun.java:14)</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208014710.png" alt="调试运行结果" title="调试运行结果"></p><p>可见还是有同样的问题，运行到 <code>ModuleBRun ()</code> 方法时已经出错了，根源就在于多版本的 <code>guava</code> 之间无法兼容。</p><p>这里需要注意的是，在 <code>module-a</code> 中并不能随意调用 <code>module-c</code> 中 <code>guava v26.0-jre</code> 的方法，如果方法不存在的话编译不会通过【<code>maven</code> 先加载了低版本的 <code>guava v19.0</code>】。而单独看 <code>module-c</code> 的话，它是一个独立的子模块，所以 <code>module-c</code> 中的方法不受编译的限制，只有在把 <code>module-a</code> 打包后，真正运行时才会抛出异常。</p><p>具体可以参考 <code>ModuleARun</code> 中的 <code>runGuava ()</code> 方法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">     * 依赖 b/c 时或者依赖 b/c-shade 时:</span><br><span class="line">     * 在这里无法像 module-c 那样直接调用 26.0-jre 里面的方法，编译无法通过 </span><br><span class="line">     * 但是 module-c 里面的代码是单独处于模块里面，编译时无法检测，所以 ModuleCRun.run () 可以通过编译 (编译阶段不会检测 run 里面的代码)</span><br><span class="line">     * &lt;p&gt;</span><br><span class="line">     * 所以:</span><br><span class="line">     * 制作 shade 只是可以保证 ModuleCRun.run () 正常执行，并不能保证 Strings.lenientFormat 可用 (连编译都无法通过)</span><br><span class="line">     */</span><br><span class="line">public static void runGuava () &#123;</span><br><span class="line">	log.info (&quot;==== 开始执行 module-a 的 guava v19.0 代码 & quot;);</span><br><span class="line">	Objects.ToStringHelper toStringHelper = Objects.toStringHelper (new Object ());</span><br><span class="line">	toStringHelper.add (&quot;in&quot;, &quot;in&quot;);</span><br><span class="line">	toStringHelper.add (&quot;out&quot;, &quot;out&quot;);</span><br><span class="line">	log.info (&quot;====[&#123;&#125;]&quot;, toStringHelper.toString ());</span><br><span class="line">	log.info (&quot;====module-a 的 guava v19.0 代码执行完成 & quot;);</span><br><span class="line">	log.info (&quot;&quot;);</span><br><span class="line">	log.info (&quot;==== 开始执行 module-a 的 guava v26.0-jre 代码 & quot;);</span><br><span class="line">	//        log.info (&quot;====[&#123;&#125;]&quot;, Strings.lenientFormat (&quot;&quot;, &quot;in&quot;, &quot;out&quot;));</span><br><span class="line">	log.info (&quot;====module-a 的 guava v26.0-jre 代码执行完成 & quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="插件登场"><a href="# 插件登场" class="headerlink" title="插件登场"></a>插件登场</h2><p>看似疑无路，其实还有柳暗花明，使用 <code>maven-shade-plugin</code> 插件可以完美解决上述的问题。</p><p>在 <code>module-c</code> 的 <code>pom.xml</code> 配置文件中，给插件 <code>maven-shade-plugin</code> 添加 <code>relocation</code> 配置，把 <code>com.google.common</code> 包路径变为 <code>iplaypi.com.google.common</code>，要确保独一无二，总体内容如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 非常好用的 shade 插件 --&gt;</span><br><span class="line">&lt;plugin&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;maven-shade-plugin.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;executions&gt;</span><br><span class="line">        &lt;execution&gt;</span><br><span class="line">            &lt;!-- Maven 的生命周期 --&gt;</span><br><span class="line">            &lt;phase&gt;package&lt;/phase&gt;</span><br><span class="line">            &lt;goals&gt;</span><br><span class="line">                &lt;!-- 插件目标 --&gt;</span><br><span class="line">                &lt;goal&gt;shade&lt;/goal&gt;</span><br><span class="line">            &lt;/goals&gt;</span><br><span class="line">            &lt;configuration&gt;</span><br><span class="line">                &lt;!-- 配置多版本 jar 包中类路径的重命名 --&gt;</span><br><span class="line">                &lt;relocations&gt;</span><br><span class="line">                    &lt;relocation&gt;</span><br><span class="line">                        &lt;pattern&gt;com.google.common&lt;/pattern&gt;</span><br><span class="line">                        &lt;shadedPattern&gt;iplaypi.com.google.common&lt;/shadedPattern&gt;</span><br><span class="line">                    &lt;/relocation&gt;</span><br><span class="line">                &lt;/relocations&gt;</span><br><span class="line">            &lt;/configuration&gt;</span><br><span class="line">        &lt;/execution&gt;</span><br><span class="line">    &lt;/executions&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208185321.png" alt="给 C 模块添加 relocation" title="给 C 模块添加 relocation"></p><p>此外，在 <code>module-a</code> 中也需要配置常规的打包参数，使用 <code>mainClass</code> 指定主类，使用 <code>shadedClassifierName</code> 指定 <code>jar</code> 包后缀【不会用到 <code>relocation</code> 的功能】，内容如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugin&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;maven-shade-plugin.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;executions&gt;</span><br><span class="line">        &lt;execution&gt;</span><br><span class="line">            &lt;!-- Maven 的生命周期 --&gt;</span><br><span class="line">            &lt;phase&gt;package&lt;/phase&gt;</span><br><span class="line">            &lt;goals&gt;</span><br><span class="line">                &lt;!-- 插件目标 --&gt;</span><br><span class="line">                &lt;goal&gt;shade&lt;/goal&gt;</span><br><span class="line">            &lt;/goals&gt;</span><br><span class="line">            &lt;configuration&gt;</span><br><span class="line">                &lt;transformers&gt;</span><br><span class="line">                    &lt;!-- 使用资源转换器 ManifestResourceTransformer, 可执行的 jar 包 --&gt;</span><br><span class="line">                    &lt;transformer</span><br><span class="line">                                        implementation=&quot;org.apache.maven.plugins.shade.resource.ManifestResourceTransformer&quot;&gt;</span><br><span class="line">                        </span><br><span class="line">                     &lt;!-- 指定主类入口 --&gt;                       &lt;mainClass&gt;org.playpi.study.ModuleARun&lt;/mainClass&gt;</span><br><span class="line">                    &lt;/transformer&gt;</span><br><span class="line">                &lt;/transformers&gt;</span><br><span class="line">                &lt;!-- 指定 jar 包后缀 --&gt;</span><br><span class="line">                &lt;shadedClassifierName&gt;jar-with-dependencies&lt;/shadedClassifierName&gt;</span><br><span class="line">            &lt;/configuration&gt;</span><br><span class="line">        &lt;/execution&gt;</span><br><span class="line">    &lt;/executions&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208185900.png" alt="给 A 模块添加打包参数" title="给 A 模块添加打包参数"></p><p>接着就可以编译打包了：<code>mvn clean package</code>，打包完成后，在 <code>target</code> 目录下找到最终的 <code>jar</code> 包，使用 <code>java</code> 命令执行：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar iplaypistudy-shade-module-a-1.0-SNAPSHOT-jar-with-dependencies.jar</span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">2020-02-08_19:08:04 [main] INFO study.ModuleARun:12: ====Hello World!</span><br><span class="line">2020-02-08_19:08:04 [main] INFO study.ModuleARun:23: ==== 开始执行 module-a 的代码 </span><br><span class="line">2020-02-08_19:08:04 [main] INFO study.ModuleBRun:19: ==== 开始执行 module-b 的代码 </span><br><span class="line">2020-02-08_19:08:04 [main] INFO study.ModuleBRun:23: ====[Object&#123;in=in, out=out</span><br><span class="line">]</span><br><span class="line">2020-02-08_19:08:04 [main] INFO study.ModuleBRun:24: ====module-b 的代码执行完成 </span><br><span class="line">2020-02-08_19:08:04 [main] INFO study.ModuleCRun:18: ==== 开始执行 module-c 的代码 </span><br><span class="line">2020-02-08_19:08:04 [main] INFO study.ModuleCRun:20: ====[[in, out]]</span><br><span class="line">2020-02-08_19:08:04 [main] INFO study.ModuleCRun:21: ====module-c 的代码执行完成 </span><br><span class="line">2020-02-08_19:08:04 [main] INFO study.ModuleARun:26: ====module-a 的代码执行完成 </span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208190909.png" alt="运行成功" title="运行成功"></p><p>可以看到运行结果，所有的方法都调用成功，说明不存在多版本的 <code>jar</code> 包冲突的问题了。</p><p>注意，此时不能使用 <strong>调试运行的方法 </strong>，读者会发现使用 <code>IDEA</code> 等工具直接调试运行，仍旧会出错，这是因为 <code>IDEA</code> 调试运行只是经过了 <code>compile</code> 阶段，而 <code>maven-shade-plugin</code> 插件中的 <code>shade relocation</code> 根本没有执行。由于我们配置的 <code>phase</code> 是 <code>package</code>【绑定到 <code>Maven</code> 的 <code>package</code> 生命周期】，因此，必须经过打包后，直接指定 <code>main</code> 主类运行 <code>jar</code> 包，才会看到效果。</p><p>为了知其然也知其所以然，我们肯定要看看 <code>jar</code> 包到底发生了什么变化，找到 <code>jar</code> 包，使用 <code>Java Decompiler</code> 工具反编译字节码文件，查看 <code>.java</code> 文件有什么变化，我们首先能想到的就是类路径变化了。</p><p>找到 <code>Strings</code> 类文件，可以看到它的类路径变化了，已经变为了 <code>iplaypi.com.google.common.base</code>，同时它所 <code>import</code> 的类路径也添加了 <code>iplaypi</code> 前缀。</p><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208192045.png" alt="反编译查看源码" title="反编译查看源码"></p><p>也就是说，打包完成之后，在 <code>jar</code> 包里面可以看到原本 <code>com.google.common</code> 下面的类全部被保留，<code>guava v19.0</code> 的类路径没有变化，而 <code>guava v26.0-jre</code> 的所有类路径都被添加了前缀 <code>iplaypi.</code>，而这正是 <code>shade</code> 的功劳。如此一来，高、低版本的所有类都分离开了，调用方可以任意使用，不会再有冲突或者缺失的情况。</p><p>那我们再看看调用方的 <code>import</code> 是怎样的，分别找到 <code>ModuleBRun</code>、<code>ModuleCRun</code> 类。</p><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208192409.png" alt="反编译后的 ModuleBRun" title="反编译后的 ModuleBRun"></p><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208192525.png" alt="反编译后的 ModuleCRun" title="反编译后的 ModuleCRun"></p><p>从 <code>ModuleCRun</code> 中可以看到，调用方的代码类的 <code>import</code> 类路径也被同步替换。当然，由于 <code>ModuleBRun</code> 并没有参与 <code>shade relocation</code> 流程，所以 <code>import</code> 还是原来的样子。</p><p><strong>总结来说 </strong>，其实 <code>maven-shade-plugin</code> 插件并没有什么难以理解的地方，它只是帮助我们在构建 <code>jar</code> 包时，把特定的类路径转换为了我们指定的新路径，同时把所有调用方的 <code>import</code> 语句也改变了，这样就能确保这些类在加载到 <code>JVM</code> 中是独一无二的，也就不会冲突了【当然会造成最后的 <code>uber jar</code> 变大了，加载到 <code>JVM</code> 中的类也变多了】。</p><p>它的效果概念图如下：</p><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208195142.png" alt="效果概念图" title="效果概念图"></p><p>当然，只看到现象还不够，下面我们来探讨一下它的实现方法，读者请看下一小节：<strong> 实现分析 </strong>。</p><h2 id="实现分析"><a href="# 实现分析" class="headerlink" title="实现分析"></a>实现分析</h2><p>想要分析 <code>maven-shade-plugin</code> 插件是如何实现这个功能的，源代码少不了，下面简单分析一下，可以直接打断点调试一下源代码，跟着源代码跑一遍打包的流程即可。</p><p>首先，需要下载源代码，在 <code>GitHub</code> 上面下载：<a href="https://github.com/apache/maven-shade-plugin/tree/maven-shade-plugin-3.2.1" target="_blank" rel="noopener">maven-shade-plugin</a> ，注意下载后切换到指定版本的，例如我使用的版本是 <code>v3.2.1</code>，则 <code>git clone</code> 后需要 <code>git checkout</code> 到指定的 <code>tag</code>【例如：<code>maven-shade-plugin-3.2.1</code>】。</p><p>源码下载成功后，它其实也是一个 <code>Maven</code> 项目【如果导入时 <code>IDEA</code> 识别不了，可以先 <code>Open</code> 看一下，需要一些初始化动作】，可以直接以 <code>Module</code> 的形式导入 <code>IDEA</code> 中，然后就可以直接被我们自己的项目依赖。</p><p>在 <code>IDEA</code> 中依次选择 <code>File</code>、<code>New</code>、<code>Module from existing Sources</code>【也可以在 <code>Project Structure</code> 中直接添加】，最终选择已经下载的项目源码，导入过程中还需要选择一些配置，例如项目为 <code>Maven</code> 类型、项目名称，直接使用默认值即可。</p><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200209205501.png" alt="添加模块" title="添加模块"></p><p>由于有部分 <code>jar</code> 包需要从远程仓库拉取，如果网络不好的话【或者没配置国内的仓库、镜像】，速度有点慢，需要耐心等待。</p><p>添加成功后，需要确保 <code>maven-shade-plugin</code> 模块正常，通过 <code>File</code>、<code>Project Structure</code>、<code>Module</code> 查看。</p><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200209205616.png" alt="检查模块" title="检查模块"></p><p>此时，我们 <code>module-a</code> 的 <code>pom.xml</code> 文件中配置的 <code>maven-shade-plugin</code> 插件，实际使用的就不是本地仓库的了，而是我们导入的 <code>Module</code>，这样就可以调试代码了。</p><p>找到 <code>maven-shade-plugin</code> 插件的入口，<code>Maven</code> 规定一般是 <code>@Mojo</code> 注解类的 <code>execute ()</code> 方法，我在这里找到类：<code>org.apache.maven.plugins.shade.mojo.ShadeMojo</code>，<code>execute ()</code> 方法在代码 381 行，在这个方法入口处 385 行：<code>setupHintedShader ();</code>，打上断点。</p><p>具体的生成 <code>jar</code> 包以及 <code>shade relocation</code> 功能的实现逻辑在 <code>org.apache.maven.plugins.shade.DefaultShader</code> 中，我们在 160 行的 <code>shadeJars ()</code> 方法中打上断点。</p><p>接着准备调试的步骤，可以增加一个 <code>Run/Debug Configuration</code>，把 <code>mvn clean package</code> 配置成为一个 <code>Application</code>，最后点击 <code>debug</code> 按钮就可以调试了。也可以直接选中项目右键，依次选择 <code>Debug Maven</code>、<code>debug: package</code>，直接进行调试，我使用的就是这种方式，如下图：</p><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200209205712.png" alt="开始调试" title="开始调试"></p><p>首先进入到第一个断点：<code>execute ()</code> 方法，说明调试程序执行正常，直接进入到下一个断点：<code>shadeJars ()</code> 方法【注意，我这里截图执行的是 <code>module-c</code> 打包的流程，列出的 <code>jar</code> 包仅和 <code>module-c</code> 有关】：</p><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200209205731.png" alt="execute 方法" title="execute 方法"></p><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200209205746.png" alt="shadeJars 方法" title="shadeJars 方法"></p><p>可以从 <code>shadeRequest</code> 对象中看到 <code>jar</code> 包列表，以及 <code>relocators</code> 列表，<code>shade relocation</code> 的代码逻辑在 <code>org.apache.maven.plugins.shade.relocation.SimpleRelocator</code> 里面，里面有替换类路径、文件路径的操作实现。</p><p>接着进入到 <code>shadeSingleJar ()</code> 方法，可以看到对每一个文件进行处理，替换、合并等操作。</p><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200209205801.png" alt="shadeSingleJar 方法" title="shadeSingleJar 方法"></p><p>最后也可以测试一下，如果不对 <code>module-c</code> 做 <code>shade relocation</code>，最终项目打包收集的所有 <code>jar</code> 包中，是没有 <code>guava v26.0-jre</code> 的，只有 <code>guava v19.0</code>，这也可以解释为什么运行时会缺失。</p><h2 id="另一种情况"><a href="# 另一种情况" class="headerlink" title="另一种情况"></a>另一种情况</h2><p>假设 <code>module-c</code> 不是我们自己维护的模块，我们无权限变更，更不可能直接去更改它的 <code>pom.xml</code> 文件，此时应该怎么办。可以把 <code>module-c</code> 类比成一个独立的 <code>jar</code> 包，拥有自己的坐标，由开源组织发布【例如 <code>hive-client</code>、<code>hbase-client</code>】，被 <code>module-a</code> 依赖引用，此时我们不可能去更改它的配置文件或者代码。</p><p>也有办法，那就是为这类 <code>jar</code> 包单独创建一个独立的 <code>module</code>，在这个 <code>module</code> 中完成 <code>shade</code> 操作，然后才把这个 <code>module</code> 给我们的项目引用。</p><p>在本例中，就以 <code>module-c</code> 为例，假如我们没有权限更改 <code>module-c</code> 中的代码、配置文件，只能新创建一个 <code>module-c-shade</code>，它里面什么代码都没有，只是简单地依赖 <code>module-c</code>，然后在配置文件 <code>pom.xml</code> 中做一个 <code>shade relocation</code>，把可能冲突的类解决掉。</p><p>项目结构如下图：</p><p><img src="https://raw.githubusercontent.com/iplaypi/img-playpi/master/img/2019/20200208200838.png" alt="复杂情况的传递依赖" title="复杂情况的传递依赖"></p><p>和上面的效果一致，编译打包后，依旧可以成功运行。</p><p>可以多思考一下，根据上面的情况，还有在什么场景下需要单独创建一个 <code>module</code>，里面没有任何代码，只是为了做影子依赖呢？</p><p>最先想到的肯定是类似上面那种，传递依赖导致的冲突，例如项目中依赖了 <code>es-hadoop</code>，而由此带来的 <code>guava</code>、<code>http</code> 等 <code>jar</code> 包冲突，我们不可能想着去改 <code>es-hadoop</code> 的 <code>pom.xml</code> 文件，因为我们不应当变更源码【太麻烦而且不利于管理】，当然也不一定能拿到源码。那么，只能单独创建一个 <code>module</code>，使用 <code>maven-shade-plugin</code> 插件做 <code>shade relocation</code>。</p><p>另外还有一种情况，如果传递依赖过多，例如 <code>es-hadoop</code> 中的 <code>guava</code>，<code>hbase</code> 中的 <code>commons-lang</code>，也没有必要为每一个 <code>jar</code> 包都单独创建一个 <code>module</code>，显得繁琐而且没必要。此时可以只创建一个 <code>module</code>，用来解决所有的依赖冲突，但是如果这些 <code>jar</code> 包之间的传递依赖本来就冲突，那还是得为每一个 <code>jar</code> 包都创建一个 <code>module</code>【此时这种 <code>Maven</code> 项目冲突过多，是不健康的，还是升级适配为好】。</p><h1 id="备注"><a href="# 备注" class="headerlink" title="备注"></a>备注</h1><p>1、新建 <code>module</code> 时如果卡住，可以设置参数 <code>archetypeCatalog=internal</code> 解决。</p><p>2、还要注意一点，低版本的 <code>maven-shade-plugin</code> 插件并不支持 <code>relocation</code> 参数来制作影子，编译时会报错，例如 <code>v2.4.3</code> 就不行，需要 <code>v3.0</code> 以上，例如：<code>v3.1.0</code>、<code>v3.2.1</code>。</p><p>3、引入新依赖后，要确保传递依赖不能污染了当前项目的依赖，而制作 <code>shade</code> 的目的在于这个新依赖不会有异常。</p><p>当前项目中或者当前项目的依赖中，会有一些调用，如果被传递依赖污染，会导致异常。如果是当前项目的代码显式调用，编译不会通过，但是如果是在依赖 <code>jar</code> 中调用，编译阶段是检测不出来的，只会在运行调用时抛出异常。</p><p>使用上面的例子来说，如果在 <code>module-a</code> 中与 <code>module-b</code> 中的依赖有相同的，则在 <code>module-a</code> 中代码引用使用时【不是 <code>module-a</code> 中我们写的代码，而是 <code>module-a</code> 中 <code>jar</code> 的源代码】，确保使用的是 <code>module-a</code> 中的版本对应的类或者方法【即把 <code>module-b</code> 中的依赖给排除掉】，否则编译会通过，但是打包后还是会缺失。</p><p>因为 <code>jar</code> 包中的源代码在编译阶段不会被检测调用的是哪个依赖里面的类或者方法【编译时只会检测我们写的代码】，必须是打包运行后才明确【其实运行前就会把所有 <code>jar</code> 包的类加载到 <code>JVM</code> 中，由于冲突会丢弃一些】，但是运行前的加载 <code>JVM</code> 过程对于多版本的依赖无法确定具体是哪个依赖生效，编译完成后到运行的时候【执行到 <code>jar</code> 中相应的代码】，就会出问题。注意这里虽然在 <code>module-b</code> 中对部分依赖做了 <code>shade</code>，但是只是对 <code>module-b</code> 生效，而对 <code>module-a</code> 是无效的，所以可能会导致 <code>module-a</code> 中的 <code>jar</code> 中源代码引用时找不到类或者方法，于是编译打包正常，运行时就会出现 <code>NoClassDefFoundError</code> 异常。</p></div><div><div id="wechat_subscriber" style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center"><img id="wechat_subscriber_qcode" src="/images/wechat-qr-personal.jpg" alt="虾丸派 wechat" style="width:200px;max-width:100%"><div>扫一扫添加博主，进技术交流群，共同学习进步</div></div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>永不止步</div><button id="rewardButton" disable="enable" onclick='var e=document.getElementById("QR");"none"===e.style.display?e.style.display="block":e.style.display="none"'><span>打赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"><img id="wechat_qr" src="/images/wechat-pay-playpi.png" alt="虾丸派 微信支付"><p>微信支付</p></div></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong> 虾丸派</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://www.playpi.org/2019120101.html" title="解决 jar 包冲突的神器：maven-shade-plugin">https://www.playpi.org/2019120101.html</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Maven/" rel="tag"><i class="fa fa-tag"></i> Maven</a> <a href="/tags/Java/" rel="tag"><i class="fa fa-tag"></i> Java</a> <a href="/tags/shade/" rel="tag"><i class="fa fa-tag"></i> shade</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2019112901.html" rel="next" title="Spark 项目依赖冲突问题总结"><i class="fa fa-chevron-left"></i> Spark 项目依赖冲突问题总结</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2019121901.html" rel="prev" title="大数据平台框架常用参数优化">大数据平台框架常用参数优化 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="vcomments"></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/favicon-1536x1536-playpi.png" alt="虾丸派"><p class="site-author-name" itemprop="name">虾丸派</p><p class="site-description motion-element" itemprop="description">记录知识 | 分享技术</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">136</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">12</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">284</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/iplaypi" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://weibo.com/u/3086148515" target="_blank" title="微博"><i class="fa fa-fw fa-weibo"></i>微博</a> </span><span class="links-of-author-item"><a href="mailto:playpi@qq.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div><div class="cc-license motion-element" itemprop="license"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank" rel="external nofollow"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://github.com/iplaypi" title="GitHub" target="_blank" rel="external nofollow">GitHub</a></li><li class="links-of-blogroll-item"><a href="https://weibo.com/u/3086148515" title="Weibo" target="_blank" rel="external nofollow">Weibo</a></li><li class="links-of-blogroll-item"><a href="https://www.playpi.org" title="虾丸派" target="_blank" rel="external nofollow">虾丸派</a></li><li class="links-of-blogroll-item"><a href="https://www.playpi.org" title="playpi" target="_blank" rel="external nofollow">playpi</a></li><li class="links-of-blogroll-item"><a href="https://www.liaoxuefeng.com" title="廖雪峰" target="_blank" rel="external nofollow">廖雪峰</a></li><li class="links-of-blogroll-item"><a href="http://www.ruanyifeng.com" title="阮一峰" target="_blank" rel="external nofollow">阮一峰</a></li><li class="links-of-blogroll-item"><a href="https://travis-ci.org/iplaypi/iplaypi.github.io" title="travis-ci" target="_blank" rel="external nofollow">travis-ci</a></li><li class="links-of-blogroll-item"><a href="https://www.vultr.com/?ref=7861302-4F" title="Vultr" target="_blank" rel="external nofollow">Vultr</a></li></ul></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前提场景"><span class="nav-number">1.</span> <span class="nav-text">前提场景</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#解决方案演示"><span class="nav-number">2.</span> <span class="nav-text">解决方案演示</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#案例说明"><span class="nav-number">2.1.</span> <span class="nav-text">案例说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#代码清单"><span class="nav-number">2.2.</span> <span class="nav-text">代码清单</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#运行效果"><span class="nav-number">2.3.</span> <span class="nav-text">运行效果</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#插件登场"><span class="nav-number">2.4.</span> <span class="nav-text">插件登场</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实现分析"><span class="nav-number">2.5.</span> <span class="nav-text">实现分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#另一种情况"><span class="nav-number">2.6.</span> <span class="nav-text">另一种情况</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#备注"><span class="nav-number">3.</span> <span class="nav-text">备注</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2016&ndash;<span itemprop="copyrightYear">2020</span> <span class="post-meta-divider">|</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">虾丸派</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">全站字数统计</span> <span title="全站字数统计">302.3k 字</span></div><div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io" rel="external nofollow">Hexo</a> 强力驱动</div><span class="post-meta-divider">|</span><div class="theme-info">主题&nbsp;<a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next" rel="external nofollow">NexT.Mist</a><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-divider">|</span> 总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-divider">|</span> 总访客 <span id="busuanzi_value_site_uv"></span> 人</span></div><div class="busuanzi-count"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script><script src="//unpkg.com/valine@1.3.7/dist/Valine.min.js"></script><script type="text/javascript">new Valine({av:AV,el:"#comments",verify:!1,notify:!1,app_id:"FC5Jijeg1meo2K2OzPYWK327-gzGzoHsz",app_key:"6A1ReY8tjhPutK00F01YbJSq",placeholder:"没有问题吗？"})</script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){function r(e,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===t&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url),d=[],g=[];if(""!=l&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}d=d.concat(e(t,h,!1)),g=g.concat(e(t,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;w<0&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(t){b+="<a href='"+f+'\'><p class="search-result">'+s(p,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){var e=27===t.which&&$(".search-popup").is(":visible");e&&onPopupClose()})</script><script>!function(){var t=document.createElement("script"),s=window.location.protocol.split(":")[0];"https"===s?t.src="https://zz.bdstatic.com/linksubmit/push.js":t.src="http://push.zhanzhang.baidu.com/push.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.3"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{scale:1,jsonPath:"/live2dw/assets/hijiki.model.json"},display:{position:"left",width:100,height:200,hOffset:0,vOffset:-20},mobile:{show:!1,motion:!0,scale:.3},log:!1})</script></body></html><!-- rebuild by neat -->